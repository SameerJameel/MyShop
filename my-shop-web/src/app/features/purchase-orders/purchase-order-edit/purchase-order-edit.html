<div class="page" dir="rtl">

  <div class="top">
    <div class="title">
      <h1>{{ id ? 'تعديل طلبية شراء' : 'طلبية شراء جديدة' }}</h1>
      <div class="sub">
        <span class="status" [class.locked]="!canEdit()">
          الحالة: {{ status === 'Draft' ? 'مسودة' : status === 'Sent' ? 'مرسلة' : status === 'Received' ? 'مستلمة' : status }}
        </span>
      </div>
    </div>

    <div class="top-actions">
      <button class="btn ghost" type="button" (click)="cancel()">رجوع</button>
      <button class="btn primary" type="button" [disabled]="saving || !canEdit()" (click)="save()">
        {{ saving ? 'جارِ الحفظ...' : 'حفظ' }}
      </button>
   
    <!--  -->
    <button class="btn primary" type="button" (click)="submit()" [disabled]="saving || !canEdit()">تأكيد الاستلام</button>
  </div>
 </div>
  <div *ngIf="loading" class="state">جارِ التحميل...</div>
  <div *ngIf="error" class="state error">{{ error }}</div>

  <form *ngIf="!loading" [formGroup]="form" class="form">

    <div class="panel">
      <div class="grid">
        <div class="field">
          <label>المورد</label>
          <select formControlName="vendorId" [disabled]="!canEdit()">
            <option [ngValue]="null">اختر المورد</option>
            <option *ngFor="let v of vendors" [ngValue]="v.id">{{ v.name }}</option>
          </select>
          <small *ngIf="form.get('vendorId')?.touched && form.get('vendorId')?.invalid">المورد مطلوب</small>
        </div>

        <div class="field">
          <label>التاريخ</label>
          <input type="date" formControlName="orderDate" [disabled]="!canEdit()">
        </div>

        <div class="field">
          <label>خصم (اختياري)</label>
          <input type="number" formControlName="discountAmount" [disabled]="!canEdit()">
        </div>

        <div class="field">
          <label>دفعة/مدفوع (اختياري)</label>
          <input type="number" formControlName="paidAmount" [disabled]="!canEdit()">
        </div>
      </div>

      <div class="field">
        <label>ملاحظات عامة</label>
        <textarea rows="2" formControlName="notes" [disabled]="!canEdit()"></textarea>
      </div>
    </div>

    <!-- Lines -->
    <div class="lines-head">
      <h2>الأصناف في الطلبية</h2>
      <button class="btn add" type="button" (click)="addLine()" [disabled]="!canEdit()">+ إضافة صنف</button>
    </div>

    <div class="lines" formArrayName="lines">
      <div class="line-card"
           *ngFor="let line of lines.controls; let i = index"
           [formGroupName]="i">

        <!-- Header (always visible) -->
        <div class="line-header" (click)="toggleLine(i)">
          <div class="h-left">
            <div class="name">{{ line.value['name'] || 'صنف جديد' }}</div>
            <div class="mini">
              <span class="pill">الكمية: {{ line.value['orderedQuantity'] || 0 }}</span>
              <span class="pill">الإجمالي: {{ lineTotal(line) | currency:'JOD' }}</span>
            </div>
          </div>
          <div class="h-right">
            <span class="chev">{{ line.value['expanded'] ? '▲' : '▼' }}</span>
          </div>
        </div>

        <!-- Body -->
        <div class="line-body" *ngIf="line.value['expanded']">

          <div class="grid2">
            <div class="field">
              <label>الصنف</label>
              <select formControlName="itemId" (change)="onItemChange(i)" [disabled]="!canEdit()">
                <option [ngValue]="null">اختر الصنف</option>
                <option *ngFor="let it of items" [ngValue]="it.id">{{ it.name }}</option>
              </select>
              <small *ngIf="line.get('itemId')?.touched && line.get('itemId')?.invalid">الصنف مطلوب</small>
            </div>

            <div class="field">
              <label>الكمية</label>
              <input type="number" formControlName="orderedQuantity" [disabled]="!canEdit()">
              <small *ngIf="line.get('orderedQuantity')?.touched && line.get('orderedQuantity')?.invalid">الكمية مطلوبة</small>
            </div>

            <div class="field">
              <label>سعر الشراء</label>
              <input type="number" formControlName="purchasePrice" [disabled]="!canEdit()">
              <small *ngIf="line.get('purchasePrice')?.touched && line.get('purchasePrice')?.invalid">سعر الشراء مطلوب</small>
            </div>

            <div class="field">
              <label>سعر البيع</label>
              <input type="number" formControlName="salePrice" [disabled]="!canEdit()">
            </div>
          </div>

          <div class="total-row">
            <div class="label">الإجمالي</div>
            <div class="value">{{ lineTotal(line) | currency:'JOD' }}</div>
          </div>

          <div class="field">
            <label>ملاحظات على السطر (اختياري)</label>
            <textarea rows="2" formControlName="notes" [disabled]="!canEdit()"></textarea>
          </div>

          <div class="line-actions">
            <button class="btn success" type="button" (click)="collapseLine(i)" [disabled]="!canEdit()">تم</button>
            <button class="btn danger" type="button" (click)="removeLine(i)" [disabled]="!canEdit()">حذف</button>
          </div>

        </div>
      </div>
    </div>

    <!-- Summary -->
    <div class="summary">
      <div class="row">
        <span>إجمالي الطلبية</span>
        <strong>{{ totalAmount | currency:'JOD' }}</strong>
      </div>
    </div>

  </form>
</div>
